<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GRIT EDU 관리자 툴</title>
<link rel="icon" type="image/png" href="/assets/favicon.png">
<style>
  body{font-family:'Noto Sans KR','Pretendard',system-ui,-apple-system,Segoe UI,Roboto;margin:0;background:#fff;color:#222}
  .wrap{max-width:1080px;margin:20px auto;padding:0 16px}
  h1{display:flex;align-items:center;gap:8px;margin:0 0 16px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input,textarea,button{font-size:14px}
  input[type="text"], input[type="password"]{height:38px;padding:0 10px;border:1px solid #ddd;border-radius:8px}
  textarea{width:100%;min-height:90px;border:1px solid #ddd;border-radius:8px;padding:8px}
  .btn{height:38px;padding:0 14px;border:1px solid #ddd;border-radius:8px;background:#fff;cursor:pointer}
  .btn.primary{background:#ff7a00;border-color:#ff7a00;color:#fff}
  .btn.danger{background:#f04438;border-color:#f04438;color:#fff}
  table{width:100%;border-collapse:collapse;margin-top:12px}
  th,td{border:1px solid #eee;padding:8px;vertical-align:top}
  th{background:#f7f7f7}
  .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;white-space:pre-wrap;border:1px solid #eee;border-radius:8px;padding:10px;background:#fafafa;margin-top:12px}
  .sub{color:#666;font-size:12px}
</style>
</head>
<body>
<div class="wrap">
  <h1>📋 GRIT EDU 관리자 툴</h1>
  <p class="sub">학생 명단과 강의 정보를 CSV로 관리하고, 각 학생 JSON을 자동 생성합니다. (자동 저장 있음)</p>

  <div class="row" style="margin:12px 0">
    <label>기본 이메일 도메인:
      <input id="domain" type="text" value="@gmail.com" style="width:240px">
    </label>
    <button class="btn" id="btnSaveAll">저장</button>
    <button class="btn danger" id="btnReset">전체 초기화</button>
  </div>

  <div class="row" style="margin:12px 0">
    <button class="btn" id="btnCsvTemplate">CSV 템플릿 다운로드</button>
    <input id="csvFile" type="file" accept=".csv" class="btn">
    <button class="btn" id="btnCsvExport">CSV 내보내기</button>
    <button class="btn primary" id="btnJsonZip">JSON ZIP 다운로드</button>
  </div>

  <table id="tbl">
    <thead>
      <tr>
        <th style="width:160px">이름</th>
        <th style="width:220px">이메일(아이디만)</th>
        <th style="width:200px">비고</th>
        <th>강의 입력<br><span class="sub">한 줄당 1개: <b>제목 | URL/ID</b> (전체 URL 붙여넣기 가능)</span></th>
        <th style="width:70px">삭제</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="row" style="margin-top:10px">
    <button class="btn" id="btnAdd">학생 추가</button>
  </div>

  <pre id="preview" class="mono"></pre>
</div>

<script>
const LS_KEY = 'grit_admin_state_v2';

function stateDefault(){
  return {
    domain: '@gmail.com',
    students: [] // {name,emailId,note,raw}
  };
}
let STATE = loadState();

function loadState(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return stateDefault();
    const parsed = JSON.parse(raw);
    return { ...stateDefault(), ...parsed };
  }catch(e){ return stateDefault(); }
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(STATE));
  paint();
}
function paint(){
  document.getElementById('domain').value = STATE.domain;
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = STATE.students.map((s,idx)=>`
    <tr>
      <td><input type="text" value="${escapeHtml(s.name||'')}" data-k="name" data-i="${idx}" style="width:100%"></td>
      <td><div style="display:flex;align-items:center;gap:4px">
            <input type="text" value="${escapeHtml(s.emailId||'')}" data-k="emailId" data-i="${idx}" style="width:100%">
            <span>${escapeHtml(STATE.domain)}</span>
          </div></td>
      <td><input type="text" value="${escapeHtml(s.note||'')}" data-k="note" data-i="${idx}" style="width:100%"></td>
      <td><textarea data-k="raw" data-i="${idx}" placeholder="예) 수학 | https://www.youtube.com/watch?v=VIDEOID&#10;예) 영어 | https://www.youtube.com/playlist?list=PLAYLISTID">${escapeHtml(s.raw||'')}</textarea></td>
      <td><button class="btn danger" data-del="${idx}">삭제</button></td>
    </tr>
  `).join('');

  // 이벤트: 저장 버튼에서만 저장 (연속 타자 문제 해결)
  document.querySelectorAll('input[data-k], textarea[data-k]').forEach(el=>{
    el.addEventListener('input', ()=>{/* 미리보기만 갱신 */ preview() });
  });

  document.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const i = +btn.dataset.del;
      STATE.students.splice(i,1);
      saveState();
    });
  });

  preview();
}
function preview(){
  const obj = { domain: STATE.domain, students: STATE.students };
  document.getElementById('preview').textContent = JSON.stringify(obj,null,2);
}
function escapeHtml(s=''){ return String(s).replace(/[&<>"]/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])) }

// CSV 템플릿
document.getElementById('btnCsvTemplate').addEventListener('click', ()=>{
  const csv = 'name,emailId,note,courses\r\n홍길동,hong,비고 예시,"수학 | https://youtu.be/abc123\r\n영어 | https://www.youtube.com/playlist?list=PLxxxx"\r\n';
  downloadBlob(csvWithBom(csv), 'grit_template.csv', 'text/csv;charset=utf-8');
});

// CSV 가져오기
document.getElementById('csvFile').addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file) return;
  const text = await file.text();
  importCsv(text);
  saveState();
});
function importCsv(text){
  // 간단 파서 (따옴표/개행 지원)
  const rows = [];
  let cur = '', cell=[], inQuote=false;
  for (let i=0;i<text.length;i++){
    const ch = text[i], nxt = text[i+1];
    if (inQuote){
      if (ch === '"' && nxt === '"'){ cur += '"'; i++; }
      else if (ch === '"'){ inQuote = false; }
      else cur += ch;
    } else {
      if (ch === '"'){ inQuote = true; }
      else if (ch === ','){ cell.push(cur); cur=''; }
      else if (ch === '\n' || ch === '\r'){
        if (ch === '\r' && nxt === '\n'){ i++; }
        cell.push(cur); rows.push(cell); cell=[]; cur='';
      } else cur += ch;
    }
  }
  if (cur.length || cell.length) { cell.push(cur); rows.push(cell); }
  // 헤더
  const [header, ...data] = rows;
  const idx = {
    name: header.indexOf('name'),
    emailId: header.indexOf('emailId'),
    note: header.indexOf('note'),
    courses: header.indexOf('courses'),
  };
  STATE.students = data
    .filter(r=>r.length>1 && (r[idx.emailId]||'').trim())
    .map(r=>({
      name: (r[idx.name]||'').trim(),
      emailId: (r[idx.emailId]||'').trim(),
      note: (r[idx.note]||'').trim(),
      raw: (r[idx.courses]||'').replace(/\r/g,'').trim()
    }));
}

// CSV 내보내기 (UTF-8 BOM)
document.getElementById('btnCsvExport').addEventListener('click', ()=>{
  const header = 'name,emailId,note,courses';
  const lines = STATE.students.map(s=>{
    const esc = v => `"${String(v||'').replace(/"/g,'""')}"`;
    return [s.name, s.emailId, s.note, s.raw].map(esc).join(',');
  });
  const csv = [header, ...lines].join('\r\n');
  downloadBlob(csvWithBom(csv), 'grit_students.csv', 'text/csv;charset=utf-8');
});

// JSON ZIP 다운로드
document.getElementById('btnJsonZip').addEventListener('click', async ()=>{
  const files = STATE.students.map(s=>{
    const email = (s.emailId||'').trim() + STATE.domain;
    const lectures = parseRawToLectures(s.raw||'');
    const json = {
      name: s.name||'',
      email: email,
      note: s.note||'',
      lectures
    };
    return { name: (s.emailId||'').trim()+'.json', content: JSON.stringify(json,null,2) };
  });
  const zipBlob = await makeZip(files);
  downloadBlob(zipBlob, 'grit_plans.zip', 'application/zip');
});

// 학생 추가
document.getElementById('btnAdd').addEventListener('click', ()=>{
  STATE.students.push({name:'',emailId:'',note:'',raw:''});
  saveState();
});

// 저장(한 번 클릭으로만 저장 반영)
document.getElementById('btnSaveAll').addEventListener('click', ()=>{
  STATE.domain = document.getElementById('domain').value.trim() || '@gmail.com';
  // 테이블 입력 읽어오기
  const rows = Array.from(document.querySelectorAll('#tbl tbody tr'));
  STATE.students = rows.map(tr=>{
    const read = (sel)=> tr.querySelector(sel)?.value ?? '';
    return {
      name: read('input[data-k="name"]').trim(),
      emailId: read('input[data-k="emailId"]').trim(),
      note: read('input[data-k="note"]').trim(),
      raw: read('textarea[data-k="raw"]').trim()
    };
  }).filter(s=>s.emailId);
  saveState();
});

// 전체 초기화
document.getElementById('btnReset').addEventListener('click', ()=>{
  if (!confirm('모든 입력을 초기화할까요?')) return;
  STATE = stateDefault();
  saveState();
});

// 유틸
function parseRawToLectures(raw){
  // 줄단위 또는 | 기준: "제목 | URL/ID"
  const lines = raw.split(/\n+/).map(l=>l.trim()).filter(Boolean);
  return lines.map(line=>{
    let title='', id='', url=line;
    // "제목 | 값" 형태면 분리
    const m = line.split('|');
    if (m.length>=2){
      title = m[0].trim();
      url   = m.slice(1).join('|').trim();
    }
    // 전체 URL이면 videoId/playlistId 추출, 아니면 그대로 id로 간주
    const yt = new URLPattern({pathname:"/:path*"}); // 브라우저 지원
    let source='youtube', type='video';
    let videoId='', playlistId='';
    try{
      const u = new URL(url);
      const v = u.searchParams.get('v'); const list = u.searchParams.get('list');
      if (v) { videoId = v; type='video'; }
      else if (list){ playlistId = list; type='playlist'; }
      else {
        // youtu.be/ID
        const parts = u.pathname.split('/').filter(Boolean);
        if (u.hostname.includes('youtu.be') && parts[0]) { videoId = parts[0]; type='video'; }
      }
    }catch(e){
      // URL 아님 → 그냥 ID로 기록
      if (/^PL/.test(url)) { playlistId = url; type='playlist'; }
      else { videoId = url; type='video'; }
    }
    const obj = { title: title||'(제목 없음)', source, type };
    if (videoId) obj.videoId = videoId;
    if (playlistId) obj.playlistId = playlistId;
    if (!videoId && !playlistId) obj.url = url; // 혹시 모를 외부 링크
    return obj;
  });
}

function csvWithBom(s){ return new Blob([new Uint8Array([0xEF,0xBB,0xBF]), s], {type:'text/csv;charset=utf-8'}); }
function downloadBlob(blob, filename, type){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
}
async function makeZip(files){
  // 작은 JS-only zip (Store)
  // 간단화를 위해 구조적 최소 구현
  const enc = new TextEncoder();
  let fileRecords = [], fileData = [], offset = 0;
  const dosTime = 0, dosDate = 0; // 생략
  const crc32 = (str) => {
    let crc = ~0, i, j;
    for (i = 0; i < str.length; i++) {
      crc = (crc ^ str.charCodeAt(i)) >>> 0;
      for (j = 0; j < 8; j++) {
        const m = -(crc & 1);
        crc = (crc >>> 1) ^ (0xEDB88320 & m);
      }
    }
    return (~crc) >>> 0;
  };
  for (const f of files){
    const data = enc.encode(f.content);
    const name = enc.encode(f.name);
    const cCrc = crc32(f.content);
    const local =
      [0x50,0x4b,3,4, 10,0, 0,0, 0,0, 0,0, 0,0, ...u32(cCrc), ...u32(data.length), ...u32(data.length), ...u16(name.length), 0, ...name, ...data];
    fileData.push(new Uint8Array(local));
    fileRecords.push({name, crc:cCrc, size:data.length, offset});
    offset += local.length;
  }
  let cd=[], cdOffset=offset;
  for (const r of fileRecords){
    const rec = [0x50,0x4b,1,2, 20,0,10,0, 0,0, 0,0, 0,0, 0,0, ...u32(r.crc), ...u32(r.size), ...u32(r.size), ...u16(r.name.length), 0,0, 0,0, 0,0, ...u16(0), ...u32(0), ...u32(r.offset), ...r.name];
    cd.push(new Uint8Array(rec));
  }
  const cdSize = cd.reduce((a,b)=>a+b.length,0);
  const end   = new Uint8Array([0x50,0x4b,5,6, 0,0, 0,0, ...u16(fileRecords.length), ...u16(fileRecords.length), ...u32(cdSize), ...u32(cdOffset), 0,0]);
  const parts = [...fileData, ...cd, end];
  const total = new Uint8Array(parts.reduce((a,b)=>a+b.length,0));
  let pos=0; for (const p of parts){ total.set(p,pos); pos+=p.length; }
  return new Blob([total], {type:'application/zip'});
  function u16(n){ return [n&255, n>>8&255]; }
  function u32(n){ return [n&255,(n>>8)&255,(n>>16)&255,(n>>24)&255]; }
}

// 초기 렌더
paint();
</script>
</body>
</html>
