<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>GRIT EDU ê´€ë¦¬ì íˆ´ â€” í•™ìƒÂ·ê°•ì˜ JSON ìë™í™” + GitHub Push</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
  :root { --brand:#ff7a00; }
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Noto Sans KR, sans-serif;
         max-width: 1100px; margin: 24px auto; padding: 0 16px; }
  h1 { margin: 0 0 6px; font-weight: 800; }
  .note { color:#666; font-size:13px; margin: 6px 0 14px; }
  .cfg, .gh { border:1px solid #eee; border-radius:10px; padding:12px; background:#fafafa; margin-top:10px;}
  .row { display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0; }
  label { display:flex; gap:6px; align-items:center; }
  input[type="text"], input[type="password"] { padding:6px 8px; font:inherit; }
  button { font: inherit; padding: 8px 12px; border-radius: 8px; cursor: pointer; border:1px solid #ddd; background:#fff; }
  button.primary { background:var(--brand); border-color:var(--brand); color:#fff; }
  button.danger { background:#e74c3c; color:#fff; border-color:#c0392b; }
  table { width:100%; border-collapse: collapse; margin-top:10px; table-layout: fixed; }
  th, td { border:1px solid #ddd; padding:8px; vertical-align: top; }
  th { background:#f8f8f8; }
  th:nth-child(1){ width:120px }
  th:nth-child(2){ width:260px }
  th:nth-child(3){ width:180px }
  th:nth-child(5){ width:80px }
  input, textarea { width:100%; font:inherit; padding:6px 8px; }
  textarea { resize: vertical; min-height: 90px; }
  .muted { color:#777; font-size:12px; }
  pre { background:#f6f6f8; padding:10px; border-radius:10px; overflow:auto; font-size:12px; }
  .email-wrap { display: flex; align-items: center; gap: 6px; white-space: nowrap; }
  .email-wrap input { flex: 1 1 auto; min-width: 120px; }
  .email-wrap .suffix { color:#666; font-size:13px; }
  .pill { background:#fff7ee; border:1px solid #ffd7b0; color:#aa5a00; padding:4px 8px; border-radius:999px; font-size:12px; }
</style>
</head>
<body>
<h1>ğŸ“š GRIT EDU ê´€ë¦¬ì íˆ´</h1>
<p class="note">í•™ìƒ ëª…ë‹¨ ë° ê°•ì˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ê³  <b>ì €ì¥ ë²„íŠ¼</b>ì„ ëˆŒëŸ¬ì•¼ ë°˜ì˜ë©ë‹ˆë‹¤. ìë™ ì €ì¥ì€ ì—†ìŠµë‹ˆë‹¤.</p>

<!-- ê¸°ë³¸ ë„ë©”ì¸ -->
<div class="cfg">
  <div class="row">
    <label>ê¸°ë³¸ ì´ë©”ì¼ ë„ë©”ì¸: <input id="domain" value="@gmail.com" style="width:200px" type="text"></label>
    <span class="pill">ì˜ˆ: ksh + @gmail.com â‡’ ksh@gmail.com</span>
  </div>
</div>

<!-- GitHub ì—…ë¡œë“œ ì„¤ì • -->
<div class="gh">
  <strong>ğŸ”— GitHub Upload ì„¤ì •</strong>
  <p class="muted">ì´ ì„¤ì •ìœ¼ë¡œ <b>members/plans/</b> ê²½ë¡œì— í•™ìƒë³„ JSONì„ ê³§ë°”ë¡œ ì»¤ë°‹í•©ë‹ˆë‹¤(ë®ì–´ì“°ê¸° ìë™).</p>
  <div class="row">
    <label>Owner: <input id="ghOwner" placeholder="gritedu" style="width:160px" type="text"></label>
    <label>Repo: <input id="ghRepo" placeholder="gritedu.github.io" style="width:220px" type="text"></label>
    <label>Branch: <input id="ghBranch" value="main" style="width:120px" type="text"></label>
    <label>Base Path: <input id="ghBase" value="members/plans" style="width:200px" type="text"></label>
  </div>
  <div class="row">
    <label>Personal Access Token: <input id="ghToken" placeholder="ghp_xxxâ€¦" style="width:420px" type="password"></label>
    <button id="saveGh" class="primary">ì €ì¥</button>
    <button id="pushGh" class="primary">GitHubì— ë°”ë¡œ í‘¸ì‹œ</button>
    <button id="clearGh" class="danger">í† í°/ì„¤ì • ì‚­ì œ</button>
  </div>
  <p class="muted">âš ï¸ í† í°ì€ ë¡œì»¬ ì €ì¥ì†Œ(LocalStorage)ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤. GitHubì—ì„œ <b>repo ê¶Œí•œ</b>ìœ¼ë¡œ ë°œê¸‰í•˜ì„¸ìš”.</p>
</div>

<div class="row" style="margin-top:12px">
  <button id="addStudent">í•™ìƒ ì¶”ê°€</button>
  <button id="importCSV">CSV ê°€ì ¸ì˜¤ê¸°</button>
  <button id="exportCSV">CSV ë‚´ë³´ë‚´ê¸°</button>
  <button id="saveAll" class="primary">ì €ì¥</button>
  <button id="exportJSON" class="primary">JSON ZIP ë‹¤ìš´ë¡œë“œ</button>
  <button id="clearAll" class="danger">ì „ì²´ ì´ˆê¸°í™”</button>
</div>

<table>
  <thead>
    <tr>
      <th>ì´ë¦„</th>
      <th>ì´ë©”ì¼(ì•„ì´ë””ë§Œ)</th>
      <th>ë¹„ê³ </th>
      <th>ê°•ì˜ ì…ë ¥<br><span class="muted">ê° ì¤„ì— â€œì œëª© | URL/IDâ€ ë˜ëŠ” â€œURL/IDâ€ (ì¬ìƒëª©ë¡ URLë„ OK)</span></th>
      <th>ì‚­ì œ</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<pre id="preview"></pre>

<script type="module">
import JSZip from "https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm";

const LS_KEY = "grit_plan_manager_v5";
const LS_GH  = "grit_plan_manager_v5_gh";
let state = JSON.parse(localStorage.getItem(LS_KEY) || '{"domain":"@gmail.com","students":[]}');
let gh    = JSON.parse(localStorage.getItem(LS_GH)  || '{"owner":"","repo":"","branch":"main","base":"members/plans","token":""}');

/* ---------- YouTube URL í‘œì¤€í™” ---------- */
function normalizeYouTubeUrl(input) {
  if (!input) return "";
  const s = input.trim();
  if (/^https?:\/\//i.test(s)) return s;

  const vParam = s.match(/(?:\?|&)v=([A-Za-z0-9_\-]{6,})/);
  if (vParam) return `https://www.youtube.com/watch?v=${vParam[1]}`;

  const short = s.match(/^youtu\.be\/([A-Za-z0-9_\-]{6,})$/i);
  if (short) return `https://www.youtube.com/watch?v=${short[1]}`;

  const listParam = s.match(/(?:\?|&)list=([A-Za-z0-9_\-]+)/);
  if (listParam) return `https://www.youtube.com/playlist?list=${listParam[1]}`;

  if (/^[A-Za-z0-9_\-]{6,}$/.test(s)) {
    return `https://www.youtube.com/watch?v=${s}`;
  }
  return s;
}

/* ---------- ìƒíƒœ ì €ì¥/ë Œë” ---------- */
function saveState() {
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  render();
}
function saveGh() {
  localStorage.setItem(LS_GH, JSON.stringify(gh));
}

function renderGh() {
  document.getElementById("ghOwner").value  = gh.owner||"";
  document.getElementById("ghRepo").value   = gh.repo||"";
  document.getElementById("ghBranch").value = gh.branch||"main";
  document.getElementById("ghBase").value   = gh.base||"members/plans";
  document.getElementById("ghToken").value  = gh.token||"";
}

function render() {
  document.getElementById("domain").value = state.domain;
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";
  state.students.forEach((s, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td><input id="name-${i}" value="${s.name||""}" placeholder="í™ê¸¸ë™" type="text"></td>
      <td>
        <div class="email-wrap">
          <input id="email-${i}" value="${s.emailId||""}" placeholder="ì•„ì´ë””ë§Œ" type="text">
          <span class="suffix">${state.domain}</span>
        </div>
      </td>
      <td><input id="note-${i}" value="${s.note||""}" placeholder="ë¹„ê³ " type="text"></td>
      <td>
        <textarea id="raw-${i}" placeholder="ì˜ˆ) ë§›ë³´ê¸° | https://youtu.be/6aPYStft9Xo
ìˆ˜í•™1ê°• | dQw4w9WgXcQ
https://www.youtube.com/playlist?list=PLAyaOmgagQpgVDOd9sT8PO0MFSHr7zaYM">${s.raw||""}</textarea>
      </td>
      <td><button data-del="${i}" class="danger">ì‚­ì œ</button></td>
    `;
    tbody.appendChild(tr);
  });

  const previewObj = {
    domain: state.domain,
    students: state.students.map(s => ({
      name: s.name, email: (s.emailId||"")+state.domain, note: s.note, raw: s.raw
    }))
  };
  document.getElementById("preview").textContent = JSON.stringify(previewObj, null, 2);

  renderGh();
}

/* ---------- ì´ë²¤íŠ¸: ìƒíƒœ ---------- */
document.getElementById("addStudent").onclick = () => {
  state.students.push({ name:"", emailId:"", note:"", raw:"" });
  render();
};

document.getElementById("clearAll").onclick = () => {
  if (confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?")) {
    localStorage.removeItem(LS_KEY);
    state = { domain:"@gmail.com", students:[] };
    render();
  }
};

document.getElementById("saveAll").onclick = () => {
  state.domain = document.getElementById("domain").value.trim() || "@gmail.com";
  state.students.forEach((s, i) => {
    s.name = document.getElementById(`name-${i}`).value.trim();
    s.emailId = document.getElementById(`email-${i}`).value.trim();
    s.note = document.getElementById(`note-${i}`).value.trim();
    s.raw = document.getElementById(`raw-${i}`).value.trim();
  });
  saveState();
  alert("âœ… ì €ì¥ ì™„ë£Œ!");
};

document.getElementById("tbody").addEventListener("click", e => {
  const idx = e.target.dataset.del;
  if (idx !== undefined) {
    state.students.splice(idx, 1);
    render();
  }
});

/* ---------- CSV: emailId,name,note ---------- */
document.getElementById("exportCSV").onclick = () => {
  const rows = [["emailId","name","note"]];
  for (const s of state.students) rows.push([s.emailId||"", s.name||"", s.note||""]);
  const csv = rows.map(r=>r.map(v=>`"${(v||"").replace(/"/g,'""')}"`).join(",")).join("\n");
  const blob = new Blob([csv], { type:"text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "grit_students_min.csv";
  a.click();
  URL.revokeObjectURL(a.href);
};

document.getElementById("importCSV").onclick = async () => {
  const inp = document.createElement("input");
  inp.type = "file"; inp.accept = ".csv,text/csv";
  inp.onchange = async () => {
    const text = await inp.files[0].text();
    const lines = text.split(/\r?\n/).filter(Boolean);
    const header = lines.shift().split(",").map(h=>h.replace(/^"|"$/g,"").trim());
    const idxE = header.indexOf("emailId");
    const idxN = header.indexOf("name");
    const idxNote = header.indexOf("note");
    if (idxE<0 || idxN<0 || idxNote<0) { alert("CSV í—¤ë”ì— emailId,name,note ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤."); return; }
    for (const line of lines) {
      const cols = line.match(/("([^"]|"")*"|[^,]*)/g).filter((_,i,arr)=>i%2===0||arr[i-1][0]!=='"'); // ì•ˆì „ ë¶„ë¦¬
      const emailId = (cols[idxE]||"").replace(/^"|"$/g,"").replace(/""/g,'"').trim();
      const name    = (cols[idxN]||"").replace(/^"|"$/g,"").replace(/""/g,'"').trim();
      const note    = (cols[idxNote]||"").replace(/^"|"$/g,"").replace(/""/g,'"').trim();
      if (!emailId) continue;
      const exist = state.students.find(s=>s.emailId===emailId);
      if (exist) { exist.name = name; exist.note = note; }
      else state.students.push({ emailId, name, note, raw:"" });
    }
    saveState();
  };
  inp.click();
};

/* ---------- ZIP(JSON) ë‚´ë³´ë‚´ê¸° ---------- */
async function sha256Hex(text) {
  const buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
  return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
}

function buildStudentJson(s, emailFull) {
  const items = (s.raw||"")
    .split(/\n/)
    .map(l=>{
      const line = l.trim(); if (!line) return null;
      let title="", val=line;
      const barIdx = line.indexOf("|");
      if (barIdx !== -1) { title = line.slice(0, barIdx).trim(); val = line.slice(barIdx+1).trim(); }
      const url = normalizeYouTubeUrl(val);
      if (!url) return null;
      if (!title) title = "ê°•ì˜";
      return { title, url };
    })
    .filter(Boolean);

  return {
    name: s.name,
    email: emailFull,
    note: s.note,
    courses: [{ title: "ì½”ìŠ¤", items }]
  };
}

document.getElementById("exportJSON").onclick = async () => {
  const zip = new JSZip();
  const manifest = [["name","email","note","hash","filename"]];
  for (const s of state.students) {
    const email = (s.emailId||"").toLowerCase() + state.domain;
    const hash = await sha256Hex(email);
    const json = buildStudentJson(s, email);
    zip.file(`${hash}.json`, JSON.stringify(json, null, 2));
    manifest.push([s.name, email, s.note, hash, `${hash}.json`]);
  }
  const csv = manifest.map(r=>r.join(",")).join("\n");
  zip.file("_manifest.csv", csv);
  const blob = await zip.generateAsync({ type:"blob" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "plans_deploy.zip";
  a.click();
  URL.revokeObjectURL(a.href);
};

/* ---------- GitHub Push (members/plans/â€¦) ---------- */
function readGhForm() {
  gh.owner  = document.getElementById("ghOwner").value.trim();
  gh.repo   = document.getElementById("ghRepo").value.trim();
  gh.branch = document.getElementById("ghBranch").value.trim() || "main";
  gh.base   = document.getElementById("ghBase").value.trim() || "members/plans";
  gh.token  = document.getElementById("ghToken").value.trim();
}

document.getElementById("saveGh").onclick = () => {
  readGhForm(); saveGh(); alert("âœ… GitHub ì„¤ì • ì €ì¥ë¨");
};
document.getElementById("clearGh").onclick = () => {
  if (!confirm("GitHub ì„¤ì •(í† í° í¬í•¨)ì„ ì‚­ì œí• ê¹Œìš”?")) return;
  gh = { owner:"", repo:"", branch:"main", base:"members/plans", token:"" };
  saveGh(); renderGh();
};

async function getFileShaIfExists(path) {
  const url = `https://api.github.com/repos/${gh.owner}/${gh.repo}/contents/${encodeURIComponent(path)}?ref=${gh.branch}`;
  const res = await fetch(url, { headers: { Authorization: `Bearer ${gh.token}`, Accept: "application/vnd.github+json" }});
  if (res.status === 200) {
    const j = await res.json();
    return j.sha;
  }
  return null; // 404 ë“±
}

async function putFile(path, content, message) {
  const sha = await getFileShaIfExists(path);
  const url = `https://api.github.com/repos/${gh.owner}/${gh.repo}/contents/${encodeURIComponent(path)}`;
  const body = {
    message,
    content: btoa(unescape(encodeURIComponent(content))),
    branch: gh.branch
  };
  if (sha) body.sha = sha;
  const res = await fetch(url, {
    method: "PUT",
    headers: {
      Authorization: `Bearer ${gh.token}`,
      Accept: "application/vnd.github+json",
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  });
  if (!res.ok) {
    const t = await res.text();
    throw new Error(`GitHub PUT ì‹¤íŒ¨ (${res.status}): ${t}`);
  }
}

document.getElementById("pushGh").onclick = async () => {
  readGhForm();
  if (!gh.owner || !gh.repo || !gh.token) { alert("Owner/Repo/Tokenì„ ì…ë ¥í•˜ì„¸ìš”."); return; }

  // í˜„ì¬ ì…ë ¥ ì €ì¥
  document.getElementById("saveAll").click();

  try {
    let ok = 0;
    for (const s of state.students) {
      const email = (s.emailId||"").toLowerCase() + state.domain;
      const hash = await sha256Hex(email);
      const json = buildStudentJson(s, email);
      const content = JSON.stringify(json, null, 2);
      const path = `${gh.base.replace(/\/+$/,'')}/${hash}.json`;
      await putFile(path, content, `chore(plans): update ${s.name || email} (${hash}.json)`);
      ok++;
    }
    alert(`âœ… GitHub í‘¸ì‹œ ì™„ë£Œ: ${ok} íŒŒì¼`);
  } catch (e) {
    console.error(e);
    alert("í‘¸ì‹œ ì‹¤íŒ¨: " + e.message);
  }
};

render();
</script>
</body>
</html>
