<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>내 강의실 - GritEdu</title>
  <link rel="stylesheet" href="../assets/css/main.css" />
  <script type="module" src="/assets/js/common.js"></script>
</head>
<body style="min-height:100vh;">
  <main class="container" style="padding:24px; margin-top:64px;">
    <h1 style="margin:0 0 16px; font-size:24px; font-weight:800;">내 강의실</h1>

    <section class="card" id="profile-card" style="margin-bottom:16px;">
      <h2>내 정보</h2>
      <div id="profile-content">로딩 중…</div>
    </section>

    <section class="card">
      <h2>수강 중인 강좌</h2>
      <p style="color:#666; margin-top:0;">
        체크하면 진행상태가 저장됩니다. (동기화: Firestore / 기기 간 공유)
      </p>
      <div id="playlist-courses" class="grid" style="margin-top:12px;"></div>
    </section>
  </main>

  <script type="module">
    import { guardPage, auth } from "../assets/js/firebase-init.js";
    import {
      getFirestore, doc, getDoc, setDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

    await guardPage();
    const db = getFirestore();
    const uid = auth.currentUser.uid;

    // 1) 프로필 카드 (관리자/학생 이름 고정 표기)
    const user = auth.currentUser;
    const email = user.email || "";
    const displayName = (email === "griteducto@gmail.com") ? "관리자" : "학생";
    document.getElementById("profile-content").innerHTML = `
      <div style="display:flex;gap:12px;align-items:center;">
        <div style="width:48px;height:48px;border-radius:24px;background:#f1f1f1;display:flex;align-items:center;justify-content:center;font-weight:800;">
          ${displayName.charAt(0)}
        </div>
        <div>
          <div style="font-weight:800;">${displayName}</div>
          <div style="color:#666;">${email}</div>
        </div>
      </div>
    `;

    // 2) 체크리스트: 유튜브 플레이리스트 2개
    const PLAYLISTS = [
      { id: "PLAyaOmgagQpgVDOd9sT8PO0MFSHr7zaYM", title: "코스 A" },
      { id: "PLAyaOmgagQpg-mZl9HSdCdBcgTySbdlub", title: "코스 B" }
    ];

    const container = document.getElementById("playlist-courses");

    // RSS 피드에서 항목 파싱
    async function fetchPlaylistItems(playlistId) {
      const url = `https://www.youtube.com/feeds/videos.xml?playlist_id=${playlistId}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error("RSS fetch failed");
      const xml = new DOMParser().parseFromString(await res.text(), "text/xml");
      const entries = Array.from(xml.getElementsByTagName("entry"));
      // 최신→오래된 순으로 되어 있을 수 있음. 필요시 reverse()
      return entries.map(entry => {
        const title = entry.getElementsByTagName("title")[0]?.textContent || "제목 없음";
        const vid = entry.getElementsByTagNameNS("http://www.youtube.com/xml/schemas/2015", "videoId")[0]?.textContent;
        return { title, videoId: vid };
      }).filter(v => !!v.videoId);
    }

    async function renderPlaylistCard(pl) {
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <h2>${pl.title}</h2>
        <div id="list-${pl.id}">로딩 중…</div>
      `;
      container.appendChild(card);

      try {
        const items = await fetchPlaylistItems(pl.id);
        const listDiv = card.querySelector(`#list-${pl.id}`);
        if (!items.length) {
          listDiv.textContent = "플레이리스트에서 항목을 찾지 못했습니다.";
          return;
        }
        listDiv.innerHTML = "";
        for (const item of items) {
          const pid = `${uid}_playlist_${pl.id}_${item.videoId}`;
          const progRef = doc(db, "progress", pid);
          const progSnap = await getDoc(progRef);
          const completed = progSnap.exists() ? !!progSnap.data().completed : false;

          const row = document.createElement("div");
          row.className = "lecture-row";
          const inputId = `chk-${pl.id}-${item.videoId}`;
          row.innerHTML = `
            <input type="checkbox" id="${inputId}" ${completed ? "checked" : ""} />
            <label for="${inputId}" style="flex:1;">
              ${item.title}
            </label>
            <a href="https://www.youtube.com/watch?v=${item.videoId}&list=${pl.id}" target="_blank" rel="noopener" style="font-size:12px;color:#ff7a00;">보기</a>
          `;
          listDiv.appendChild(row);

          row.querySelector("#" + inputId).addEventListener("change", async (e) => {
            await setDoc(progRef, {
              uid,
              courseId: `playlist_${pl.id}`,
              lectureId: item.videoId,
              completed: e.target.checked,
              updatedAt: serverTimestamp()
            }, { merge: true });
          });
        }
      } catch (err) {
        card.querySelector(`#list-${pl.id}`).textContent = "불러오기 오류: RSS 차단 또는 네트워크 문제";
        console.error(err);
      }
    }

    for (const pl of PLAYLISTS) {
      await renderPlaylistCard(pl);
    }

  </script>

  <style>
    /* 모바일 1열 */
    @media (max-width: 768px) {
      .grid { grid-template-columns: 1fr !important; }
      .card { padding: 12px; }
    }
  </style>
</body>
</html>